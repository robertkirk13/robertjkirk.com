---
// src/pages/index.astro
import { getCollection } from "astro:content";

import ContactCard from "../components/ContactCard.astro";
import TimelineEntry from "../components/TimelineEntry.astro";
import WritingFilter from "../components/WritingFilter";

import astroLogo from "../assets/rjk.svg";
import Layout from "../layouts/Layout.astro";

// Get all blog posts and sort by date
const posts = await getCollection("blog");
const sortedPosts = posts.sort(
	(a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
);

// Prepare posts data for client component
const postsData = sortedPosts.map((post) => ({
	slug: post.slug,
	title: post.data.title,
	description: post.data.description,
	formattedDate: post.data.formattedDate,
	readingTime: post.data.readingTime,
	category: post.data.category,
}));

// Get the latest post and the rest
const [latestPost, ...previousPosts] = sortedPosts;

const timelineEntries = await getCollection("timeline");
const sortedTimelineEntries = timelineEntries.sort(
	(a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
);

// Get current position (Tesla)
const currentPosition = sortedTimelineEntries.find(
	(entry) => entry.data.featuredMessage === "Current Position",
);

// Get current year for footer
const currentYear = new Date().getFullYear();
---

<Layout>
  <div class="min-h-screen p-4 md:p-6 flex flex-col">
    <div class="max-w-3xl mx-auto space-y-4 flex-grow w-full">
      <!-- Hero Section - Clean -->
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 py-2">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">
            Robert Kirk
          </h1>
          <p class="text-gray-600 dark:text-gray-400 mt-1">
            I work at the intersection of software and hardware to solve hard problems.
          </p>
        </div>
        <a
          href="/contact"
          class="px-4 py-2 bg-neutral-800 hover:bg-neutral-700 text-white text-sm rounded-full font-medium transition-all hover:scale-105"
        >
          Contact me
        </a>
      </div>

      <!-- Main Content Grid - Asymmetric Layout -->
      <div class="grid grid-cols-1 gap-4">
        <!-- Left Column: Combined Writing Section -->
        <div>
          <div class="bg-white dark:bg-neutral-950 rounded-3xl p-4 md:p-6 border border-gray-200 dark:border-neutral-800">
            <div class="flex justify-between items-center mb-6">
              <div class="flex items-center gap-3">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="lucide lucide-book-open-text text-gray-900 dark:text-white"
                >
                  <path d="M12 7v14"></path>
                  <path d="M16 12h2"></path>
                  <path d="M16 8h2"></path>
                  <path d="M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z"></path>
                  <path d="M6 12h2"></path>
                  <path d="M6 8h2"></path>
                </svg>
                <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">
                  Writing
                </h3>
              </div>
              <a
                href="/writing"
                class="text-sm text-blue-600 hover:text-blue-700 flex items-center gap-1 group/link"
              >
                View All
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="lucide lucide-arrow-right group-hover/link:translate-x-1 transition-transform"
                >
                  <path d="M5 12h14"></path>
                  <path d="m12 5 7 7-7 7"></path>
                </svg>
              </a>
            </div>

            <WritingFilter 
              client:load 
              posts={postsData} 
              showLatestFeatured={true} 
            />
          </div>
        </div>

        <!-- RIGHT COLUMN COMMENTED OUT
        <div class="space-y-4">
          {currentPosition && (
            <div class="bg-white dark:bg-neutral-950 rounded-2xl p-4 md:p-5 border border-gray-200 dark:border-neutral-800">
              <div class="flex items-center gap-2 mb-4">
                <div class="relative flex h-3 w-3">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                </div>
                <h3 class="text-sm font-semibold text-green-600 dark:text-green-400 uppercase tracking-wide">
                   Working On
                </h3>
              </div>
              <a
                href={`/timeline/${currentPosition.slug}`}
                class="block group"
              >
                <h4 class="text-xl font-semibold text-gray-900 dark:text-white mb-3 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                  {currentPosition.data.title}
                </h4>
                {currentPosition.data.description && (
                  <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                    {currentPosition.data.description}
                  </p>
                )}
                <div class="flex flex-wrap gap-2">
                  {currentPosition.data.tags?.map((tag: string) => (
                    <span class="px-3 py-1 bg-blue-50 dark:bg-blue-950/30 text-blue-600 dark:text-blue-400 rounded-full text-xs font-medium">
                      {tag}
                    </span>
                  ))}
                </div>
              </a>
              <a
                href="/timeline"
                class="mt-6 flex items-center gap-2 text-sm text-blue-600 hover:text-blue-700 group/more"
              >
                View Full Timeline
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="lucide lucide-arrow-right group-hover/more:translate-x-1 transition-transform"
                >
                  <path d="M5 12h14"></path>
                  <path d="m12 5 7 7-7 7"></path>
                </svg>
              </a>
            </div>
          )}

          <div class="bg-white dark:bg-neutral-950 rounded-2xl p-4 md:p-5 border border-gray-200 dark:border-neutral-800">
            <ContactCard
              email="hi@robertjkirk.com"
              linkedin="robertjkirk"
            />
          </div>
        </div>
        END RIGHT COLUMN COMMENTED OUT -->
      </div>
    </div>
  </div>
</Layout>
