---
// src/pages/index.astro
import { getCollection } from "astro:content";

import ContactCard from "../components/ContactCard.astro";
import TimelineEntry from "../components/TimelineEntry.astro";
import WritingFilter from "../components/WritingFilter";

import astroLogo from "../assets/rjk.svg";
import Layout from "../layouts/Layout.astro";

// Get all blog posts and sort by date
const posts = await getCollection("blog");
const sortedPosts = posts.sort(
	(a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
);

// Prepare posts data for client component
const postsData = sortedPosts.map((post) => ({
	slug: post.slug,
	title: post.data.title,
	description: post.data.description,
	formattedDate: post.data.formattedDate,
	readingTime: post.data.readingTime,
	category: post.data.category,
}));

// Get the latest post and the rest
const [latestPost, ...previousPosts] = sortedPosts;

const timelineEntries = await getCollection("timeline");
const sortedTimelineEntries = timelineEntries.sort(
	(a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
);

// Get current position (Tesla)
const currentPosition = sortedTimelineEntries.find(
	(entry) => entry.data.featuredMessage === "Current Position",
);

// Get current year for footer
const currentYear = new Date().getFullYear();
---

<Layout>
  <div class="min-h-screen p-4 md:p-6 flex flex-col">
    <div class="max-w-3xl mx-auto space-y-4 flex-grow w-full">
      <!-- Hero Section - Clean -->
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 py-2">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">
            Robert Kirk
          </h1>
          <p class="text-gray-600 dark:text-gray-400 mt-1">
            I work at the intersection of software and hardware to solve hard problems.
          </p>
        </div>
        <a
          href="/contact"
          class="px-4 py-2 bg-neutral-800 hover:bg-neutral-700 text-white text-sm rounded-full font-medium transition-all hover:scale-105"
        >
          Contact me
        </a>
      </div>

      <!-- Main Content Grid - Asymmetric Layout -->
      <div class="grid grid-cols-1 gap-4">
        <!-- Left Column: Combined Writing Section -->
        <div>
          <div class="bg-white dark:bg-neutral-950 rounded-3xl p-4 md:p-6 border border-gray-200 dark:border-neutral-800">
            <div class="flex justify-between items-center mb-6">
              <div class="flex items-center gap-3">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="lucide lucide-book-open-text text-gray-900 dark:text-white"
                >
                  <path d="M12 7v14"></path>
                  <path d="M16 12h2"></path>
                  <path d="M16 8h2"></path>
                  <path d="M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z"></path>
                  <path d="M6 12h2"></path>
                  <path d="M6 8h2"></path>
                </svg>
                <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">
                  Writing
                </h3>
              </div>
              <a
                href="/writing"
                class="text-sm text-blue-600 hover:text-blue-700 flex items-center gap-1 group/link"
              >
                View All
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="lucide lucide-arrow-right group-hover/link:translate-x-1 transition-transform"
                >
                  <path d="M5 12h14"></path>
                  <path d="m12 5 7 7-7 7"></path>
                </svg>
              </a>
            </div>

            <!-- Filter Buttons -->
            <div class="flex gap-2 mb-4 flex-wrap" id="filter-buttons">
              <button data-filter="All" class="filter-btn active px-4 py-1.5 rounded-full text-sm font-medium transition-all bg-blue-600 text-white">All</button>
              <button data-filter="Interactive" class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium transition-all bg-gray-100 dark:bg-neutral-800 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-neutral-700">Interactive</button>
              <button data-filter="Philosophy" class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium transition-all bg-gray-100 dark:bg-neutral-800 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-neutral-700">Philosophy</button>
              <button data-filter="Projects" class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium transition-all bg-gray-100 dark:bg-neutral-800 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-neutral-700">Projects</button>
            </div>

            <!-- Posts -->
            <div class="space-y-3" id="posts-container">
              {sortedPosts.map((post, index) => (
                <a
                  href={`/writing/${post.slug}`}
                  data-category={post.data.category || ""}
                  class="post-item block group bg-gray-50 dark:bg-black rounded-2xl p-4 md:p-5 border border-gray-200 dark:border-neutral-900 hover:border-blue-500 dark:hover:border-blue-500 transition-all"
                >
                  {index === 0 && (
                    <div class="flex items-center gap-2 mb-3">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles text-blue-600">
                        <path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"></path>
                      </svg>
                      <span class="text-sm font-semibold text-blue-600 uppercase tracking-wide">Latest Post</span>
                    </div>
                  )}
                  <h2 
                    class={`font-bold text-gray-900 dark:text-white mb-2 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors ${index === 0 ? 'text-xl md:text-2xl' : 'text-lg'}`}
                    transition:name={`title-${post.slug}`}
                  >
                    {post.data.title}
                  </h2>
                  {index === 0 && (
                    <p class="text-base text-gray-600 dark:text-gray-400 leading-relaxed mb-4">
                      {post.data.description}
                    </p>
                  )}
                  <div class="flex items-center gap-3 text-sm text-gray-500">
                    <span>{post.data.formattedDate}</span>
                    <span class="inline-block w-1.5 h-1.5 rounded-full bg-gray-400"></span>
                    <span>{post.data.readingTime} min read</span>
                  </div>
                </a>
              ))}
            </div>

            <script>
              document.addEventListener('astro:page-load', () => {
                const buttons = document.querySelectorAll('.filter-btn');
                const posts = document.querySelectorAll('.post-item');
                
                buttons.forEach(btn => {
                  btn.addEventListener('click', () => {
                    const filter = btn.getAttribute('data-filter');
                    
                    // Update button styles
                    buttons.forEach(b => {
                      b.classList.remove('bg-blue-600', 'text-white');
                      b.classList.add('bg-gray-100', 'dark:bg-neutral-800', 'text-gray-600', 'dark:text-gray-400');
                    });
                    btn.classList.remove('bg-gray-100', 'dark:bg-neutral-800', 'text-gray-600', 'dark:text-gray-400');
                    btn.classList.add('bg-blue-600', 'text-white');
                    
                    // Filter posts
                    posts.forEach(post => {
                      const category = post.getAttribute('data-category');
                      if (filter === 'All' || category === filter) {
                        post.style.display = 'block';
                      } else {
                        post.style.display = 'none';
                      }
                    });
                  });
                });
              });
            </script>
          </div>
        </div>

        <!-- RIGHT COLUMN COMMENTED OUT
        <div class="space-y-4">
          {currentPosition && (
            <div class="bg-white dark:bg-neutral-950 rounded-2xl p-4 md:p-5 border border-gray-200 dark:border-neutral-800">
              <div class="flex items-center gap-2 mb-4">
                <div class="relative flex h-3 w-3">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                </div>
                <h3 class="text-sm font-semibold text-green-600 dark:text-green-400 uppercase tracking-wide">
                   Working On
                </h3>
              </div>
              <a
                href={`/timeline/${currentPosition.slug}`}
                class="block group"
              >
                <h4 class="text-xl font-semibold text-gray-900 dark:text-white mb-3 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                  {currentPosition.data.title}
                </h4>
                {currentPosition.data.description && (
                  <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                    {currentPosition.data.description}
                  </p>
                )}
                <div class="flex flex-wrap gap-2">
                  {currentPosition.data.tags?.map((tag: string) => (
                    <span class="px-3 py-1 bg-blue-50 dark:bg-blue-950/30 text-blue-600 dark:text-blue-400 rounded-full text-xs font-medium">
                      {tag}
                    </span>
                  ))}
                </div>
              </a>
              <a
                href="/timeline"
                class="mt-6 flex items-center gap-2 text-sm text-blue-600 hover:text-blue-700 group/more"
              >
                View Full Timeline
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="lucide lucide-arrow-right group-hover/more:translate-x-1 transition-transform"
                >
                  <path d="M5 12h14"></path>
                  <path d="m12 5 7 7-7 7"></path>
                </svg>
              </a>
            </div>
          )}

          <div class="bg-white dark:bg-neutral-950 rounded-2xl p-4 md:p-5 border border-gray-200 dark:border-neutral-800">
            <ContactCard
              email="hi@robertjkirk.com"
              linkedin="robertjkirk"
            />
          </div>
        </div>
        END RIGHT COLUMN COMMENTED OUT -->
      </div>
    </div>
  </div>
</Layout>
